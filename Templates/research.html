{% extends "base.html" %}
{% block content %}

<div class="glass p-4 mb-3">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div>
      <nav aria-label="breadcrumb" class="mb-1">
        <ol class="breadcrumb breadcrumb-dark small mb-0">
          <li class="breadcrumb-item"><a href="{{ url_for('index') }}" class="text-light">Projects</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{ job.name }}</li>
        </ol>
      </nav>
      <div class="h5 mb-0">{{ job.name }}</div>
      <div class="muted small">Project ID: <span class="mono">{{ job.id }}</span></div>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a class="btn btn-outline-light" href="{{ url_for('export_job_csv', job_id=job.id) }}">Export CSV</a>
      <a class="btn btn-outline-light" href="{{ url_for('geo_page', job_id=job.id) }}">Geo heatmap</a>
      <a class="btn btn-outline-light" href="{{ url_for('brand_monitor_page', job_id=job.id) }}">Brand monitor</a>
      <a class="btn btn-outline-light" href="{{ url_for('auction_insights_page', job_id=job.id) }}">Auction insights</a>
      <a class="btn btn-outline-light" href="{{ url_for('creative_alerts_page', job_id=job.id) }}">Creative alerts</a>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#competitorsModal">Competitors view</button>
      <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#trendsModal">Google Trends</button>
      <form method="post" action="{{ url_for('delete_job_route', job_id=job.id) }}" class="d-inline" onsubmit="return confirm('Delete this project and all its targets, ads, and data?');">
        <button type="submit" class="btn btn-outline-danger">Delete project</button>
      </form>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-5">
    <div class="glass p-4">
      <div class="h6 mb-2">Add targets</div>
      <div class="muted small mb-2">
        Keywords list + a location. Location can be a <b>ZIP</b> (85001), <b>County, ST</b> (Maricopa County, AZ), or a SerpAPI location string.
      </div>

      <form method="post" action="{{ url_for('add_targets_route', job_id=job.id) }}">
        <label class="form-label muted">Keywords (comma or newline separated)</label>
        <textarea class="form-control" name="keywords" rows="5" placeholder="solar installation&#10;solar panels phoenix&#10;residential solar"></textarea>

        <div class="row mt-2">
          <div class="col-12">
            <label class="form-label muted">Location</label>
            <input class="form-control" name="location" placeholder="85001  OR  Maricopa County, AZ  OR  Phoenix, Arizona, United States" required>
          </div>
          <div class="col-6 mt-2">
            <label class="form-label muted">gl</label>
            <input class="form-control" name="gl" value="us">
          </div>
          <div class="col-6 mt-2">
            <label class="form-label muted">hl</label>
            <input class="form-control" name="hl" value="en">
          </div>
        </div>

        <button class="btn btn-primary w-100 mt-3">Add targets</button>
      </form>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="glass p-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="h6 mb-0">Targets</div>
        <div class="muted small">{{ targets|length }} total</div>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-hover align-middle">
          <thead>
            <tr>
              <th>ID</th><th>Keyword</th><th>Location</th><th class="mono small">Last run</th><th>Budget track</th><th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for t in targets %}
            <tr data-target-id="{{ t.id }}">
              <td class="mono">{{ t.id }}</td>
              <td>{{ t.keyword }}</td>
              <td class="muted small">
                <div>Input: <span class="mono">{{ t.location_input }}</span></div>
                <div>SerpAPI: <span class="mono">{{ t.serp_location }}</span></div>
              </td>
              <td class="mono small">{% if t.last_snapshot_utc %}{{ t.last_snapshot_utc[:19].replace('T',' ') }}{% else %}—{% endif %}</td>
              <td>
                <div class="form-check form-switch mb-0">
                  <input class="form-check-input budget-toggle" type="checkbox" data-target-id="{{ t.id }}" {{ 'checked' if t.budget_tracking_enabled else '' }}>
                  <label class="form-check-label muted small">On</label>
                </div>
              </td>
              <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-light presence-btn" data-target-id="{{ t.id }}" data-keyword="{{ t.keyword|e }}">Presence 24h</button>
                <form method="post" action="{{ url_for('run_target', job_id=job.id, target_id=t.id) }}" class="d-inline run-target-form">
                  <button type="submit" class="btn btn-sm btn-primary run-target-btn">Run (desktop+mobile)</button>
                </form>
              </td>
            </tr>
            {% endfor %}
            {% if not targets %}
            <tr><td colspan="6" class="muted">No targets yet.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="d-flex flex-wrap gap-2 mt-2">
        <button type="button" class="btn btn-outline-light btn-sm" id="lpeBatchBtn">Run LPE batch (7 days)</button>
      </div>

      <div class="muted small mt-2">
        Run snapshots daily/weekly for longitudinal competitor trends + diffing.
      </div>
    </div>
  </div>
</div>

<!-- Presence 24h Modal -->
<div class="modal fade" id="presenceModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">Presence last 24h — <span id="presenceTargetKeyword"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-end mb-2">
          <button type="button" class="btn btn-sm btn-outline-light" id="presenceRefreshBtn">Refresh now</button>
        </div>
        <div id="presenceContent" class="small"></div>
      </div>
    </div>
  </div>
</div>

<!-- Competitors Modal -->
<div class="modal fade" id="competitorsModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">Competitors on captured keywords</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="muted small mb-2">Last sync: <span class="mono" id="compSync">—</span></div>

        <div class="row g-2 mb-3">
          <div class="col-md-3">
            <label class="form-label muted">Window (days)</label>
            <select class="form-select" id="compDays">
              <option value="7">7</option>
              <option value="30">30</option>
              <option value="60">60</option>
              <option value="90">90</option>
              <option value="120">120</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label muted">Device</label>
            <select class="form-select" id="compDevice">
              <option value="all">All</option>
              <option value="desktop">Desktop</option>
              <option value="mobile">Mobile</option>
            </select>
          </div>
          <div class="col-md-6 d-grid align-items-end">
            <button class="btn btn-primary mt-4" id="loadCompetitorsBtn" onclick="loadCompetitors()">Load competitors</button>
          </div>
        </div>

        <div id="diffBox" class="mb-3"></div>

        <div class="table-responsive">
          <table class="table table-dark table-hover align-middle">
            <thead>
              <tr>
                <th>Advertiser</th>
                <th>Appearances</th>
                <th>Top-of-page share</th>
                <th>Bottom share</th>
                <th class="text-end"></th>
              </tr>
            </thead>
            <tbody id="compTableBody"></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Trends Modal -->
<div class="modal fade" id="trendsModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">Google Trends</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="muted small mb-2">Last sync: <span class="mono" id="trendSync">—</span></div>

        <div class="row g-2 mb-2">
          <div class="col-md-6">
            <label class="form-label muted">Keywords (comma or newline separated; up to 5)</label>
            <textarea class="form-control" id="trendKeywords" rows="3" placeholder="solar installation, solar panels"></textarea>
          </div>
          <div class="col-md-3">
            <label class="form-label muted">Geo</label>
            <input class="form-control" id="trendGeo" value="US">
          </div>
          <div class="col-md-3">
            <label class="form-label muted">Timeframe</label>
            <select class="form-select" id="trendTime">
              <option value="today 3-m">Last 3 months</option>
              <option value="today 12-m" selected>Last 12 months</option>
              <option value="today 5-y">Last 5 years</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="loadTrends()">Load trends</button>
        <div class="mt-3">
          <canvas id="trendChart" height="120"></canvas>
          <div id="trendError" class="muted small mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const jobId = {{ job.id }};
  const competitorUrlBase = "{{ url_for('competitor_page', job_id=job.id, advertiser='') }}";
  let trendChart;

  function fmtMM(iso){
    const d = new Date(iso);
    const mm = String(d.getUTCMonth()+1).padStart(2,"0");
    const dd = String(d.getUTCDate()).padStart(2,"0");
    const hh = String(d.getUTCHours()).padStart(2,"0");
    const mi = String(d.getUTCMinutes()).padStart(2,"0");
    return `${mm}/${dd} ${hh}:${mi} UTC`;
  }

  function pct(x){ return (x*100).toFixed(1) + "%"; }

  function esc(s){
    if (s == null || s === undefined) return "";
    const t = String(s);
    return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
  }

  function setLoading(btn, loading){
    if (!btn) return;
    btn.disabled = loading;
    btn.textContent = loading ? "Loading…" : (btn.dataset.originalText || "Load competitors");
  }

  document.getElementById("competitorsModal")?.addEventListener("show.bs.modal", function(){
    if (!document.getElementById("compTableBody").innerHTML.trim()) loadCompetitors();
  });
  const loadCompetitorsBtn = document.getElementById("loadCompetitorsBtn");
  if (loadCompetitorsBtn) loadCompetitorsBtn.dataset.originalText = loadCompetitorsBtn.textContent;

  async function loadCompetitors(){
    const btn = document.getElementById("loadCompetitorsBtn");
    setLoading(btn, true);
    const days = document.getElementById("compDays").value;
    const device = document.getElementById("compDevice").value;

    try {
      const res = await fetch(`/api/research/${jobId}/competitors?days=${days}&device=${device}`);
      const data = await res.json();
      if (!res.ok) { document.getElementById("diffBox").innerHTML = "<p class='text-danger'>Failed to load.</p>"; return; }

      document.getElementById("compSync").textContent = data.synced_at_utc ? fmtMM(data.synced_at_utc) : "—";

      const tbody = document.getElementById("compTableBody");
      tbody.innerHTML = "";

      const diffs = data.diffs || {};
      document.getElementById("diffBox").innerHTML = `
        <div class="glass p-3">
          <div class="small muted mb-1">Diffing</div>
          <div><b>New today vs yesterday:</b> ${(diffs.new_today || []).slice(0,12).map(x => esc(x)).join(", ") || "<span class='muted'>none</span>"}</div>
          <div class="mt-2"><b>Increased this week:</b> ${(diffs.increased_this_week || []).slice(0,8).map(x => esc(x.advertiser) + " (+" + x.delta + ")").join(", ") || "<span class='muted'>none</span>"}</div>
        </div>
      `;

      (data.competitors || []).forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${esc(c.advertiser)}</td>
          <td class="mono">${esc(c.appearances)}</td>
          <td class="mono">${pct(c.top_ads_share)}</td>
          <td class="mono">${pct(c.bottom_ads_share)}</td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-light" href="${competitorUrlBase}${encodeURIComponent(c.advertiser)}?days=${days}&device=${device}">
              Drilldown
            </a>
          </td>
        `;
        tbody.appendChild(tr);
      });
      if (!(data.competitors || []).length) {
        const tr = document.createElement("tr");
        tr.innerHTML = "<td colspan='5' class='muted'>No advertisers yet. Run targets (desktop+mobile) for this project to capture ads, then click Load competitors again.</td>";
        tbody.appendChild(tr);
      }
    } finally {
      setLoading(btn, false);
    }
  }

  async function loadTrends(){
    const kw = document.getElementById("trendKeywords").value;
    const geo = document.getElementById("trendGeo").value;
    const tf = document.getElementById("trendTime").value;

    const res = await fetch(`/api/trends?keywords=${encodeURIComponent(kw)}&geo=${encodeURIComponent(geo)}&timeframe=${encodeURIComponent(tf)}`);
    const data = await res.json();

    document.getElementById("trendSync").textContent = data.synced_at_utc ? fmtMM(data.synced_at_utc) : "—";

    const err = document.getElementById("trendError");
    err.textContent = data.error || "";
    const series = data.series || [];
    if (!series.length){
      if (!err.textContent) err.textContent = "No trend data returned.";
      return;
    }

    const labels = series[0].points.map(p => p.t.slice(0,10));
    const datasets = series.map(s => ({
      label: s.keyword,
      data: s.points.map(p => p.v)
    }));

    const ctx = document.getElementById("trendChart");
    if (trendChart) trendChart.destroy();
    trendChart = new Chart(ctx, {
      type:"line",
      data:{labels, datasets},
      options:{
        plugins:{legend:{labels:{color:"#cbd5e1"}}},
        scales:{x:{ticks:{color:"#cbd5e1"}}, y:{ticks:{color:"#cbd5e1"}}}
      }
    });
  }

  document.querySelectorAll(".budget-toggle").forEach(el => {
    el.addEventListener("change", async function(){
      const targetId = this.dataset.targetId;
      const enabled = this.checked;
      const btn = this;
      btn.disabled = true;
      try {
        const res = await fetch(`/api/research/${jobId}/target/${targetId}/budget-tracking`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ enabled })
        });
        const data = await res.json();
        if (!data.ok) btn.checked = !enabled;
      } catch (e) { btn.checked = !enabled; }
      btn.disabled = false;
    });
  });

  let presenceTargetId = null;
  function renderPresenceList(list) {
    const el = document.getElementById("presenceContent");
    if (!list.length) el.innerHTML = "<span class='muted'>No presence data. Enable budget tracking and use “Refresh now” (or wait for scheduler runs).</span>";
    else el.innerHTML = "<table class='table table-dark table-sm'><thead><tr><th>Advertiser</th><th>Hours present</th><th>First hour</th><th>Last hour</th></tr></thead><tbody>" +
      list.map(p => `<tr><td class='mono'>${esc(p.advertiser)}</td><td>${esc(p.hours_present)}</td><td>${p.first_hour ?? "—"}</td><td>${p.last_hour ?? "—"}</td></tr>`).join("") + "</tbody></table>";
  }
  document.querySelectorAll(".presence-btn").forEach(btn => {
    btn.addEventListener("click", async function(){
      const targetId = this.dataset.targetId;
      presenceTargetId = targetId;
      const keyword = this.dataset.keyword || "";
      document.getElementById("presenceTargetKeyword").textContent = keyword || "Target " + targetId;
      document.getElementById("presenceContent").innerHTML = "<span class='muted'>Loading…</span>";
      const modal = new bootstrap.Modal(document.getElementById("presenceModal"));
      modal.show();
      try {
        const res = await fetch(`/api/research/${jobId}/target/${targetId}/presence`);
        const data = await res.json();
        renderPresenceList(data.presence || []);
      } catch (e) {
        document.getElementById("presenceContent").innerHTML = "<span class='text-danger'>Request failed.</span>";
      }
    });
  });
  document.getElementById("presenceRefreshBtn")?.addEventListener("click", async function(){
    if (presenceTargetId == null) return;
    const btn = this;
    btn.disabled = true;
    document.getElementById("presenceContent").innerHTML = "<span class='muted'>Refreshing…</span>";
    try {
      const res = await fetch(`/api/research/${jobId}/target/${presenceTargetId}/presence-refresh`, { method: "POST" });
      const data = await res.json();
      if (data.presence) renderPresenceList(data.presence);
      else renderPresenceList([]);
    } catch (e) {
      document.getElementById("presenceContent").innerHTML = "<span class='text-danger'>Refresh failed.</span>";
    }
    btn.disabled = false;
  });

  document.querySelectorAll(".run-target-form").forEach(form => {
    form.addEventListener("submit", function(){
      const btn = form.querySelector(".run-target-btn");
      if (btn) { btn.disabled = true; btn.textContent = "Running…"; }
    });
  });

  document.getElementById("lpeBatchBtn")?.addEventListener("click", async function(){
    const btn = this;
    btn.disabled = true;
    btn.textContent = "Running…";
    try {
      const res = await fetch(`/api/research/${jobId}/lpe-batch?days=7`, { method: "POST" });
      const data = await res.json().catch(() => ({}));
      alert("LPE batch: " + (data.urls_processed ?? 0) + " URL(s) processed.");
    } catch (e) { alert("Request failed."); }
    btn.disabled = false;
    btn.textContent = "Run LPE batch (7 days)";
  });
</script>
{% endblock %}